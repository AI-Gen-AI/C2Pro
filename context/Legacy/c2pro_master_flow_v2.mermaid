%%{init: {
  'theme': 'base',
  'themeVariables': {
    'primaryColor': '#1a1a2e',
    'primaryTextColor': '#eaeaea',
    'primaryBorderColor': '#16213e',
    'lineColor': '#0f3460',
    'secondaryColor': '#0f3460',
    'tertiaryColor': '#e94560',
    'background': '#0f0f23',
    'mainBkg': '#1a1a2e',
    'nodeBorder': '#e94560',
    'clusterBkg': '#16213e',
    'clusterBorder': '#0f3460',
    'titleColor': '#eaeaea',
    'edgeLabelBackground': '#1a1a2e'
  }
}}%%

flowchart TB
    %% ============================================================
    %% ESTILOS Y CLASES
    %% ============================================================
    classDef security fill:#e94560,stroke:#fff,stroke-width:2px,color:#fff
    classDef async fill:#0f3460,stroke:#e94560,stroke-width:2px,color:#fff
    classDef error fill:#ff6b6b,stroke:#c92a2a,stroke-width:2px,color:#fff
    classDef success fill:#51cf66,stroke:#2f9e44,stroke-width:2px,color:#fff
    classDef llm fill:#845ef7,stroke:#5f3dc4,stroke-width:2px,color:#fff
    classDef human fill:#ffd43b,stroke:#fab005,stroke-width:2px,color:#fff
    classDef db fill:#20c997,stroke:#0ca678,stroke-width:2px,color:#fff
    classDef audit fill:#fd7e14,stroke:#e8590c,stroke-width:2px,color:#fff
    classDef category fill:#339af0,stroke:#1c7ed6,stroke-width:2px,color:#fff
    classDef newfeature fill:#f06595,stroke:#d6336c,stroke-width:2px,color:#fff

    %% ============================================================
    %% SUBGRAFO: USUARIOS Y ROLES (NUEVO v2.0)
    %% ============================================================
    subgraph USERS ["üë• USUARIOS Y ROLES"]
        direction TB
        
        subgraph ROLE_TYPES ["Tipos de Usuario por Empresa"]
            ADMIN["üîë Admin<br/>Full access"]
            PM["üìä Project Manager<br/>Gesti√≥n proyectos"]
            ENGINEER["‚öôÔ∏è Engineer<br/>Documentos t√©cnicos"]
            PROCUREMENT["üõí Procurement<br/>BOM/Compras"]
            QA_ROLE["‚úÖ QA/Quality<br/>Validaci√≥n"]
            VIEWER["üëÅÔ∏è Viewer<br/>Solo lectura"]
        end
        
        USER_SESSION["Sesi√≥n Usuario"]
        ROLE_CHECK{"Verificar<br/>Permisos"}
    end

    %% ============================================================
    %% SUBGRAFO: CAPA DE ENTRADA (Actualizada con UI real)
    %% ============================================================
    subgraph ENTRY ["üñ•Ô∏è FRONTEND (Next.js)"]
        direction TB
        
        subgraph VIEWS ["Vistas Principales"]
            UI_DASHBOARD["üìä Dashboard<br/>Score 78/100<br/>Trends, KPIs"]
            UI_PROJECTS["üìÅ Projects<br/>Lista con Score<br/>Status, Alerts"]
            UI_EVIDENCE["üìÑ Evidence<br/>Visor PDF<br/>Extracted Data"]
            UI_ALERTS["‚ö†Ô∏è Alerts Center<br/>Por severidad<br/>Por tipo"]
            UI_STAKEHOLDERS["üë• Stakeholders"]
            UI_RACI["üìã RACI Matrix"]
        end
        
        UI_SEARCH["üîç Search Global"]
        UI_NOTIFICATIONS["üîî Notificaciones"]
    end

    %% ============================================================
    %% SUBGRAFO: FUENTES DE DOCUMENTOS (NUEVO v2.0)
    %% ============================================================
    subgraph DOC_SOURCES ["üì• FUENTES DE DOCUMENTOS"]
        direction TB
        
        subgraph MANUAL_UPLOAD ["Upload Manual"]
            UPLOAD_UI["üì§ Drag & Drop<br/>en UI"]
            UPLOAD_API["API Upload<br/>Endpoint"]
        end
        
        subgraph FOLDER_SYNC ["üîÑ Folder Sync (NUEVO)"]
            SHARED_FOLDER[("üìÅ Carpeta<br/>Compartida<br/>SharePoint/S3/NAS")]
            SYNC_SERVICE["Sync Service<br/>Polling/Webhook"]
            VERSION_CONTROL["Control de<br/>Versiones"]
            
            SHARED_FOLDER --> SYNC_SERVICE
            SYNC_SERVICE --> VERSION_CONTROL
        end
        
        DOC_INGESTION["Document<br/>Ingestion"]
        
        UPLOAD_UI --> UPLOAD_API
        UPLOAD_API --> DOC_INGESTION
        VERSION_CONTROL --> DOC_INGESTION
    end

    %% ============================================================
    %% SUBGRAFO: PER√çMETRO DE SEGURIDAD
    %% ============================================================
    subgraph SECURITY ["üîí PER√çMETRO DE SEGURIDAD"]
        direction TB
        API_GATEWAY["API Gateway<br/>FastAPI"]
        JWT_VALIDATE{"üîí Validar<br/>JWT Token"}
        TENANT_EXTRACT["üè¢ Extraer<br/>tenant_id"]
        TENANT_CONTEXT["Inyectar<br/>TenantContext"]
        PERMISSION_CHECK{"Verificar<br/>Permisos Rol"}
        
        API_GATEWAY --> JWT_VALIDATE
        JWT_VALIDATE -->|"‚ùå Inv√°lido"| REJECT_401["401 Unauthorized"]
        JWT_VALIDATE -->|"‚úÖ V√°lido"| TENANT_EXTRACT
        TENANT_EXTRACT --> TENANT_CONTEXT
        TENANT_CONTEXT --> PERMISSION_CHECK
        PERMISSION_CHECK -->|"‚ùå Sin permiso"| REJECT_403["403 Forbidden"]
    end
    
    ENTRY --> API_GATEWAY
    ROLE_CHECK --> PERMISSION_CHECK

    %% ============================================================
    %% SUBGRAFO: ORQUESTADOR LANGGRAPH
    %% ============================================================
    subgraph ORCHESTRATOR ["üéØ ORQUESTADOR LANGGRAPH"]
        direction TB
        INTENT_CLASSIFIER{"Clasificador<br/>de Intenci√≥n"}
        AGENT_ROUTER{"üîÄ Router<br/>de Agentes"}
        STATE_MACHINE["State Machine"]
        
        INTENT_CLASSIFIER --> AGENT_ROUTER
        AGENT_ROUTER --> STATE_MACHINE
    end
    
    PERMISSION_CHECK -->|"‚úÖ Autorizado"| INTENT_CLASSIFIER

    %% ============================================================
    %% SUBGRAFO: M√ìDULO DOCUMENTS
    %% ============================================================
    subgraph MOD_DOCUMENTS ["üìÑ M√ìDULO: DOCUMENTS"]
        direction TB
        DOC_ROUTER["Router HTTP"]
        DOC_USECASE["Use Cases"]
        DOC_PORTS["Ports"]
        
        subgraph DOC_PROCESSING ["üîÑ Pipeline de Procesamiento"]
            DOC_PARSE["1. Parse<br/>PDF/DOCX/XLS"]
            DOC_EXTRACT["2. ‚ö° Entity<br/>Extraction"]
            DOC_CLASSIFY["3. Clasificar<br/>por Categor√≠a"]
            DOC_EMBED["4. ‚ö° Generate<br/>Embeddings"]
            DOC_INDEX["5. Index en<br/>Graph RAG"]
            
            DOC_PARSE --> DOC_EXTRACT
            DOC_EXTRACT --> DOC_CLASSIFY
            DOC_CLASSIFY --> DOC_EMBED
            DOC_EMBED --> DOC_INDEX
        end
        
        DOC_ROUTER --> DOC_USECASE
        DOC_USECASE --> DOC_PORTS
    end
    
    AGENT_ROUTER -->|"document_task"| DOC_ROUTER
    DOC_INGESTION --> DOC_PROCESSING

    %% ============================================================
    %% SUBGRAFO: COHERENCE ENGINE v2.0 (6 CATEGOR√çAS)
    %% ============================================================
    subgraph MOD_COHERENCE ["üéØ COHERENCE ENGINE v2.0"]
        direction TB
        COH_ROUTER["Router HTTP"]
        COH_USECASE["Use Cases"]
        COH_PORTS["Ports"]
        
        subgraph COHERENCE_CATEGORIES ["üìä 6 Categor√≠as de Coherencia"]
            direction LR
            CAT_SCOPE["üéØ SCOPE<br/>Alcance"]
            CAT_BUDGET["üí∞ BUDGET<br/>Costos"]
            CAT_QUALITY["‚úÖ QUALITY<br/>Est√°ndares"]
            CAT_TECHNICAL["‚öôÔ∏è TECHNICAL<br/>Ingenier√≠a"]
            CAT_LEGAL["‚öñÔ∏è LEGAL<br/>Contratos"]
            CAT_TIME["‚è±Ô∏è TIME<br/>Cronograma"]
        end
        
        subgraph COHERENCE_LOGIC ["Motor de C√°lculo"]
            RULES_ENGINE["12 Reglas<br/>Deterministas<br/>2 por categor√≠a"]
            LLM_QUALITATIVE["‚ö° LLM<br/>An√°lisis<br/>Cualitativo"]
            
            subgraph SCORE_CALC ["C√°lculo de Score"]
                SCORE_GLOBAL["Score Global<br/>78/100"]
                SCORE_SCOPE["Score Scope"]
                SCORE_BUDGET["Score Budget"]
                SCORE_QUALITY["Score Quality"]
                SCORE_TECHNICAL["Score Technical"]
                SCORE_LEGAL["Score Legal"]
                SCORE_TIME["Score Time"]
            end
            
            RULES_ENGINE --> SCORE_CALC
            LLM_QUALITATIVE -.->|"fallback"| SCORE_CALC
        end
        
        COH_ROUTER --> COH_USECASE
        COH_USECASE --> COH_PORTS
        COH_USECASE --> COHERENCE_CATEGORIES
        COHERENCE_CATEGORIES --> COHERENCE_LOGIC
    end
    
    AGENT_ROUTER -->|"coherence_task"| COH_ROUTER

    %% ============================================================
    %% SUBGRAFO: SISTEMA DE ALERTAS (Clasificado por Categor√≠a)
    %% ============================================================
    subgraph ALERT_SYSTEM ["‚ö†Ô∏è SISTEMA DE ALERTAS"]
        direction TB
        
        ALERT_GENERATOR["Generador<br/>de Alertas"]
        
        subgraph ALERT_TYPES ["Tipos de Alerta por Categor√≠a"]
            direction LR
            ALERT_SCOPE["üéØ Scope"]
            ALERT_BUDGET["üí∞ Financial"]
            ALERT_QUALITY["‚úÖ Quality"]
            ALERT_TECHNICAL["‚öôÔ∏è Technical"]
            ALERT_LEGAL["‚öñÔ∏è Legal"]
            ALERT_SCHEDULE["‚è±Ô∏è Schedule"]
        end
        
        subgraph SEVERITY_LEVELS ["Niveles de Severidad"]
            SEV_CRITICAL["üî¥ Critical"]
            SEV_HIGH["üü† High"]
            SEV_MEDIUM["üü° Medium"]
            SEV_LOW["üü¢ Low"]
        end
        
        ALERT_QUEUE["Cola de<br/>Alertas"]
    end
    
    SCORE_CALC --> ALERT_GENERATOR
    ALERT_GENERATOR --> ALERT_TYPES
    ALERT_TYPES --> SEVERITY_LEVELS
    SEVERITY_LEVELS --> ALERT_QUEUE

    %% ============================================================
    %% SUBGRAFO: HUMAN-IN-THE-LOOP (Como en UI Evidence)
    %% ============================================================
    subgraph HUMAN_LOOP ["üë§ HUMAN-IN-THE-LOOP"]
        direction TB
        
        SEVERITY_CHECK{"Severidad?"}
        
        subgraph REVIEW_PANEL ["Panel de Revisi√≥n"]
            EXTRACTED_DATA["Extracted Data<br/>Confidence %"]
            LINKAGES["Linkages<br/>WBS items"]
            ALERT_BADGE["Alert Badge"]
        end
        
        subgraph USER_ACTIONS ["Acciones de Usuario"]
            BTN_APPROVE["‚úÖ Approve"]
            BTN_REJECT["‚ùå Reject"]
            BTN_IGNORE["‚è≠Ô∏è Ignorar"]
            BTN_NOTE["üìù Nota"]
            BTN_RERUN["üîÑ Re-ejecutar"]
        end
        
        SEVERITY_CHECK -->|"Critical/High"| REVIEW_PANEL
        SEVERITY_CHECK -->|"Medium/Low"| AUTO_PROCESS["Auto-proceso"]
        REVIEW_PANEL --> USER_ACTIONS
    end
    
    ALERT_QUEUE --> SEVERITY_CHECK
    BTN_RERUN --> LLM_QUALITATIVE

    %% ============================================================
    %% SUBGRAFO: M√ìDULOS DE NEGOCIO
    %% ============================================================
    subgraph BUSINESS_MODULES ["üì¶ M√ìDULOS DE NEGOCIO"]
        direction TB
        
        subgraph MOD_PROJECTS ["üìÅ Projects"]
            PRJ_LIST["Lista Proyectos"]
            PRJ_DETAIL["Detalle"]
            PRJ_WBS["WBS"]
        end
        
        subgraph MOD_STAKEHOLDERS ["üë• Stakeholders"]
            STK_LIST["Lista"]
            RACI_MATRIX["RACI Matrix"]
        end
        
        subgraph MOD_PROCUREMENT ["üõí Procurement"]
            BOM_LIST["BOM Items"]
            PROC_PLAN["Plan"]
        end
    end
    
    AGENT_ROUTER -->|"project_task"| MOD_PROJECTS
    AGENT_ROUTER -->|"stakeholder_task"| MOD_STAKEHOLDERS
    AGENT_ROUTER -->|"procurement_task"| MOD_PROCUREMENT

    %% ============================================================
    %% SUBGRAFO: CAPAS DE PERSISTENCIA
    %% ============================================================
    subgraph DATA_STORES ["üíæ PERSISTENCIA"]
        direction TB
        SUPABASE_DB[("üè¢ PostgreSQL<br/>+ RLS")]
        NEO4J_GRAPH[("üîó Neo4j")]
        VECTOR_STORE[("üìê Vectors")]
        
        subgraph TABLES ["Tablas Clave"]
            T_USERS["users + roles"]
            T_DOCUMENTS["documents"]
            T_ALERTS["alerts<br/>con category"]
            T_COHERENCE["coherence_scores<br/>6 sub-scores"]
        end
    end
    
    DOC_PORTS --> SUPABASE_DB
    DOC_INDEX --> NEO4J_GRAPH
    DOC_EMBED --> VECTOR_STORE
    COH_PORTS --> SUPABASE_DB

    %% ============================================================
    %% SUBGRAFO: ERROR RECOVERY
    %% ============================================================
    subgraph ERROR_RECOVERY ["üî¥ ERROR RECOVERY"]
        direction TB
        CIRCUIT_BREAKER{"Circuit<br/>Breaker"}
        RETRY_LOGIC["Retry"]
        FALLBACK["Fallback"]
        
        CIRCUIT_BREAKER -->|"open"| FALLBACK
        CIRCUIT_BREAKER -->|"half-open"| RETRY_LOGIC
    end
    
    LLM_QUALITATIVE -->|"error"| CIRCUIT_BREAKER

    %% ============================================================
    %% SUBGRAFO: OBSERVABILIDAD
    %% ============================================================
    subgraph OBSERVABILITY ["üìä OBSERVABILIDAD"]
        TRACE_ID["trace_id"]
        AI_COSTS["AI Usage $30/d√≠a"]
    end
    
    API_GATEWAY --> TRACE_ID

    %% ============================================================
    %% SUBGRAFO: AUDIT TRAIL
    %% ============================================================
    subgraph AUDIT ["üìã AUDITOR√çA"]
        AUDIT_LOG["audit_logs"]
    end
    
    BTN_APPROVE --> AUDIT_LOG
    BTN_REJECT --> AUDIT_LOG

    %% ============================================================
    %% SUBGRAFO: SALIDA AL USUARIO
    %% ============================================================
    subgraph OUTPUT ["‚úÖ RESPUESTA"]
        RESPONSE_BUILD["Build Response"]
        UPDATE_DASHBOARD["Actualizar Dashboard"]
        NOTIFY_USER["üîî Notificar"]
    end
    
    AUTO_PROCESS --> RESPONSE_BUILD
    BTN_APPROVE --> RESPONSE_BUILD
    RESPONSE_BUILD --> UPDATE_DASHBOARD
    RESPONSE_BUILD --> NOTIFY_USER
    UPDATE_DASHBOARD --> UI_DASHBOARD
    NOTIFY_USER --> UI_NOTIFICATIONS

    %% ============================================================
    %% CONEXIONES INTER-M√ìDULO
    %% ============================================================
    DOC_PORTS <-.->|"DTO"| COH_PORTS

    %% ============================================================
    %% APLICACI√ìN DE ESTILOS
    %% ============================================================
    class JWT_VALIDATE,TENANT_EXTRACT,PERMISSION_CHECK security
    class SYNC_SERVICE,DOC_PROCESSING async
    class CIRCUIT_BREAKER,FALLBACK,REJECT_401,REJECT_403 error
    class BTN_APPROVE,AUTO_PROCESS success
    class LLM_QUALITATIVE,DOC_EXTRACT,DOC_EMBED llm
    class REVIEW_PANEL,USER_ACTIONS human
    class SUPABASE_DB,NEO4J_GRAPH,VECTOR_STORE db
    class AUDIT_LOG audit
    class CAT_SCOPE,CAT_BUDGET,CAT_QUALITY,CAT_TECHNICAL,CAT_LEGAL,CAT_TIME category
    class SHARED_FOLDER,SYNC_SERVICE,VERSION_CONTROL newfeature
