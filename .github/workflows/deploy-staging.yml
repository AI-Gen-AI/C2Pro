name: Deploy to Staging

on:
  push:
    branches:
      - main

# Concurrency control to ensure only one deployment runs at a time for this workflow.
# 'staging' is the environment name, and cancel-in-progress will cancel older runs.
concurrency:
  group: staging
  cancel-in-progress: true

jobs:
  # This job consolidates all CI checks.
  # Deployment jobs will depend on this job's success.
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Backend Checks
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: apps/api/requirements.txt
      - name: Install backend dependencies
        run: pip install -r apps/api/requirements.txt
      - name: Run backend linters and tests
        env:
          DATABASE_URL: ${{ secrets.POSTGRES_DB_URL }}
          POSTGRES_DB_URL: ${{ secrets.POSTGRES_DB_URL }}
          REDIS_URL: ${{ secrets.REDIS_URL }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          pip install ruff mypy pytest
          ruff check apps/api --verbose
          ruff format apps/api --check
          mypy apps/api/src/
          pytest apps/api/

      # Frontend Checks
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: apps/web/package-lock.json
      - name: Install frontend dependencies
        working-directory: apps/web
        run: npm ci
      - name: Run frontend linter and build
        working-directory: apps/web
        run: |
          npm run lint
          npm run build

  deploy-backend:
    name: Deploy Backend to Railway
    needs: build-and-test # This job will only run if build-and-test is successful
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Deploy to Railway
        uses: railway/cli@v2
        with:
          # This command links and deploys the latest version to Railway.
          # The RAILWAY_TOKEN secret must be set in the repository secrets.
          # The project ID can be found in your Railway project settings.
          command: |
            railway link your-railway-project-id
            railway up --detach
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          DATABASE_URL: ${{ secrets.POSTGRES_DB_URL }}
          POSTGRES_DB_URL: ${{ secrets.POSTGRES_DB_URL }}
          REDIS_URL: ${{ secrets.REDIS_URL }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

  deploy-frontend:
    name: Deploy Frontend to Vercel
    needs: build-and-test # This job will only run if build-and-test is successful
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v25 # Pinning to a specific version is a good practice
        with:
          # These secrets must be configured in your repository's secrets.
          # VERCEL_TOKEN, VERCEL_ORG_ID, and VERCEL_PROJECT_ID are required.
          # The 'scope' and 'working-directory' are important for monorepos.
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: "--prod" # Deploy to the production environment in Vercel
          scope: ${{ secrets.VERCEL_ORG_ID }}
          working-directory: apps/web
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
