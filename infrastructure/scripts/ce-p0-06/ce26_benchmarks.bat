@echo off
REM CE-26: Performance Benchmarks
REM Runs performance analysis and benchmarks

setlocal enabledelayedexpansion

set SCRIPT_DIR=%~dp0
set PROJECT_ROOT=%SCRIPT_DIR%..\..
set LOG_DIR=%PROJECT_ROOT%\logs

echo ==================================
echo CE-26: Performance Benchmarks
echo ==================================
echo Started at: %date% %time%
echo.

REM Load environment variables
if exist "%PROJECT_ROOT%\.env.staging" (
    for /f "usebackq tokens=*" %%a in ("%PROJECT_ROOT%\.env.staging") do set %%a
)

REM 1. Index usage analysis
echo --- Step 1: Index Usage Analysis ---
psql "%DATABASE_URL%" -f "%SCRIPT_DIR%\analyze_index_usage.sql" > "%LOG_DIR%\ce26_index_usage.log" 2>&1
type "%LOG_DIR%\ce26_index_usage.log"

REM 2. Query performance tests
echo.
echo --- Step 2: Query Performance Tests ---
psql "%DATABASE_URL%" -f "%SCRIPT_DIR%\performance_benchmarks.sql" > "%LOG_DIR%\ce26_performance.log" 2>&1
type "%LOG_DIR%\ce26_performance.log"

echo.
echo √ Performance benchmarks completed

REM Generate report
(
echo # Performance Benchmark Report
echo **Date**: %date% %time%
echo **Task**: CE-26 Performance Benchmarks
echo.
echo ## Results
echo √ Index usage analyzed
echo √ Query performance tested
echo.
echo ## Logs
echo - Index Usage: `%LOG_DIR%\ce26_index_usage.log`
echo - Performance: `%LOG_DIR%\ce26_performance.log`
echo.
echo ## Next Steps
echo - Review query execution times
echo - Check for unused indexes
echo - Verify performance degradation ^<10%%
echo.
echo ---
echo Generated by CE-26 benchmark script
) > "%PROJECT_ROOT%\docs\ce26_performance_report.md"

echo.
echo ==================================
echo CE-26 Benchmarks Complete!
echo ==================================
echo Status: READY FOR CE-27
echo Completed at: %date% %time%

endlocal
